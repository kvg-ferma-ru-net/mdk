version: '3.0'

services:

  db:
    image: mysql:5.7
    container_name: mdk-db
    environment:
      MYSQL_ROOT_PASSWORD: root
    command: ['mysqld', '--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci']
    networks:
      - mdk-network

  backend:
    image: registry.git.innokassa.ru/byurrer/docker-images/php7.1-cli:dev
    user: www-data
    container_name: mdk-backend
    extra_hosts:
      - "host.docker.internal:172.16.1.1"
    depends_on: 
      - db
    volumes:
      - ./src/:/var/www/html/src/
      - ./tests/:/var/www/html/tests/
      - ./composer.json:/var/www/html/composer.json
      - ./phpstan.neon:/var/www/html/phpstan.neon
      - ./phpunit.xml:/var/www/html/phpunit.xml
      - ./.env/php/test.sh:/usr/bin/test.sh
      - ./.env/php/wait-db.php:/var/www/html/wait-db.php
    command: /bin/bash -c "/usr/bin/test.sh"
    networks:
      - mdk-network

networks:
  mdk-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.16.1.1/24
